<div class="row">
  <div class="col-12">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <h1>VIBE v3.1</h1>
        <p class="lead">Variant Interpretation using Biomedical literature Evidence (<a href="https://github.com/molgenis/vibe">GitHub</a><!-- | <a href="http://localhost:8080/">Paper</a>--> | <a href="https://github.com/molgenis/vibe/blob/3.0/database/LICENSES.md">Database</a>)</p>
        <div class="jumbotron">
          <form id="vibe-form">
            <div class="input-group mb-3">
              <input id="inputPhenotypes" type="text" class="form-control" placeholder="Enter HPO term identifier(s)" aria-label="HPO term(s)" aria-describedby="hpoTermsHelp">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="submit" id="executeButton">Execute</button>
              </div>
            </div>
            <small id="hpoTermsHelp" class="form-text text-muted">Comma-separated list of <a href="https://hpo.jax.org/">Human Phenotype Ontology</a> term identifiers (e.g. HP:0002996).</small>
          </form>
        </div>
        <div id="progress" style="display: none;">
          <div class="d-flex align-items-center">
            <strong>Your request is being processed, usually takes a couple of minutes ...</strong>
            <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div>
          </div>
        </div>
        <table id="previewTable" class="table" style="display: none; table-layout: fixed;">
          <colgroup>
            <col style="width:92px;" />
            <col />
          </colgroup>
          <thead>
          <tr>
            <th>Gene</th>
            <th>Diseases (with scores)</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p id="errorText" style="display: none;">Error occurred while processing request.</p>
        <p id="resultText" style="display: none;">Done. Click <a id="resultAnchor">here</a> to download the result</p>
      </div>
    </div>
  </div>
</div>
<script>
  var value = getParameterByName('phenotypes', window.location.href);
  console.log("pheno:" + value);
  console.log("genes:" + getParameterByName('genes', window.location.href));
  if(value){
    document.getElementById('inputPhenotypes').value = value;
    runVibe(value)
  }

  document.getElementById('previewTable').style.display = 'none';
  document.getElementById('errorText').style.display = 'none';
  document.getElementById('resultText').style.display = 'none';
  document.getElementById('progress').style.display = 'none';

  function handleCompletedVibeJob(jobExecution) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (this.readyState != 4) return;
      document.getElementById('executeButton').removeAttribute("disabled")
      if (this.status == 200) {
        var parsedJson = JSON.parse(this.responseText);
        var content = '<tbody>';

        // Goes through all genes.
        for(var geneId in parsedJson['genes']) {
          // Generates the gene column.
          var geneColumn = '<td>' + parsedJson['genes'][geneId]['symbol'] + '</td>';

          // Retrieves & sorts all combinations belonging to the gene.
          var combinationsForGene = parsedJson['combinations'].filter(function(combination) {
            return combination['geneId'] == geneId;
          });
          sortCombinations(combinationsForGene);

          // Generates the disease column.
          var diseasesColumn = '<td style="white-space:pre;"><div style="overflow-x:auto;">';
          combinationsForGene.forEach((combination, combinationIndex) => {
            diseasesColumn += '<div style="float:left;width:60px;"';

            // First combination contains highest score (due to sorted).
            if(combinationIndex == 0) {
              diseasesColumn += 'class="maxScore"';
            }

            diseasesColumn += '>' + combination['disgenetScore'] + '</div>' + parsedJson['diseases'][combination['diseaseId']]['name'] + '<br />';
          });
          diseasesColumn += '</div></td>';

          // The order in which the columns should be presented.
          content += '<tr>' + geneColumn + diseasesColumn + '</tr>';
        }
        content += '</tbody>';

        // Writes content to HTML table.
        var table = document.getElementById('previewTable');
        table.insertAdjacentHTML('beforeend', content);

        // Sorts the rows.
        sortPreviewTable();

        // Layout changes.

        document.getElementById('resultAnchor').setAttribute("href", jobExecution.resultUrl);
        document.getElementById('previewTable').style.display = 'table';
        document.getElementById('resultText').style.display = 'block';
        document.getElementById('progress').style.display = 'none';
      } else {
        document.getElementById('previewTable').style.display = 'none';
        document.getElementById('errorText').style.display = 'block';
        document.getElementById('resultText').style.display = 'none';
        document.getElementById('progress').style.display = 'none';
      }
    };
    xhr.open('GET', '/api/vibe?id=' + jobExecution.identifier, true);
    xhr.send();
  }

  /* Sorts combinations based on highest disgenetScore first */
  function sortCombinations(combinations) {
    combinations.sort(function(a,b) {
      if( a['disgenetScore'] < b['disgenetScore'] ) {
        return 1;
      }
      if( a['disgenetScore'] > b['disgenetScore'] ) {
        return -1;
      }
      return 0;
    });
  }

  /* Sorts previewTable based on highest score per gene */
  function sortPreviewTable() {
    var previewRows = $('#previewTable tbody');

    previewRows.find('tr').sort(function(a,b) {
      var rowA = $(a).find('div.maxScore').text();
      var rowB = $(b).find('div.maxScore').text();

      if( rowA < rowB ) {
        return 1;
      }
      if( rowA > rowB ) {
        return -1;
      }
      return 0;
    }).appendTo(previewRows);
  }

  function pollVibeJob(jobExecutionId) {
    setTimeout(function() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState != 4) return;
        if (this.status == 200) {
          var jobExecution = JSON.parse(this.responseText);
          if (jobExecution.status === 'PENDING' || jobExecution.status === 'RUNNING' || jobExecution.status === 'CANCELING') {
            pollVibeJob(jobExecutionId);
          } else {
            handleCompletedVibeJob(jobExecution)
          }
        } else {
          document.getElementById('executeButton').removeAttribute("disabled")
          document.getElementById('previewTable').style.display = 'none';
          document.getElementById('errorText').style.display = 'block';
          document.getElementById('resultText').style.display = 'none';
          document.getElementById('progress').style.display = 'none';
        }
      };
      xhr.open('GET', '/api/v2/sys_job_VibeJobExecution/' + jobExecutionId, true);
      xhr.send();
    }, 1000);
  }
  document.getElementById('vibe-form').addEventListener("submit", function(e) {
    e.preventDefault();
    document.getElementById('executeButton').setAttribute("disabled", "disabled")
    jQuery('#previewTable > tbody').remove();

    var value = document.getElementById('inputPhenotypes').value

    runVibe(value);
  });

  function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  function runVibe(value) {
    document.getElementById('resultText').style.display = 'none';
    document.getElementById('progress').style.display = 'block';

    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (this.readyState != 4) return;
      if (this.status == 200) {
        pollVibeJob(JSON.parse(this.responseText).identifier);
      } else {
        document.getElementById('executeButton').removeAttribute("disabled")
        document.getElementById('errorText').style.display = 'block';
        document.getElementById('resultText').style.display = 'none';
        document.getElementById('progress').style.display = 'none';
      }
    };
    xhr.open('POST', '/api/vibe?p=' + value, true);
    xhr.send();
  }
</script>